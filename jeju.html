<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>济州美食地图 | Jeju Travel Map</title>
    <meta name="description" content="济州岛美食地图 - 烤肠、烤肉、炖鲭鱼、酱蟹">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css?v=20260301a">
</head>
<body>
    <div id="map"></div>

    <!-- 메인으로 버튼 -->
    <a href="index.html" style="position:fixed;top:16px;left:16px;z-index:1000;background:#fff;border-radius:10px;padding:10px 16px;font-size:0.9rem;font-family:'PingFang SC','Microsoft YaHei',sans-serif;font-weight:600;color:#333;text-decoration:none;box-shadow:0 2px 8px rgba(0,0,0,0.2);display:flex;align-items:center;gap:6px;">
        <i class="fas fa-arrow-left"></i> 返回主页
    </a>

    <!-- 내 위치 찾기 버튼 -->
    <button id="locate-btn" class="locate-button" title="找到我的位置">
        <i class="fas fa-location-crosshairs"></i>
    </button>

    <!-- 지도 타일 선택 -->
    <div class="tile-selector">
        <label for="tile-select">
            <i class="fas fa-map"></i>
            <span>地图样式</span>
        </label>
        <select id="tile-select" class="tile-select">
            <option value="positron" selected>简洁</option>
            <option value="streets">街道</option>
            <option value="satellite">卫星</option>
            <option value="transit">交通</option>
        </select>
    </div>

    <!-- 범례 -->
    <div class="legend-box">
        <span class="legend-item">
            <span class="legend-color" style="background:#8B5A6B;"></span>景点
        </span>
        <span class="legend-item">
            <span class="legend-color" style="background:#6B8E5A;"></span>美食
        </span>
        <span class="legend-item">
            <span class="legend-color" style="background:#7B9EA8;"></span>住宿
        </span>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
    // ===== 지도 초기화 =====
    const map = L.map('map', {
        center: [33.4000, 126.5500],
        zoom: 10,
        zoomControl: true
    });

    const tileLayers = {
        positron: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '© OpenStreetMap, © CartoDB', subdomains: 'abcd', maxZoom: 19 }),
        streets:  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors', maxZoom: 19 }),
        satellite:L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '© Esri', maxZoom: 19 }),
        transit:  L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap, HOT', maxZoom: 19 })
    };
    tileLayers.positron.addTo(map);

    document.getElementById('tile-select').addEventListener('change', function() {
        Object.values(tileLayers).forEach(l => map.removeLayer(l));
        tileLayers[this.value].addTo(map);
    });

    // 내 위치
    document.getElementById('locate-btn').addEventListener('click', function() {
        map.locate({ setView: true, maxZoom: 14 });
    });

    // ===== 마커 데이터 =====
    const TYPE_CONFIG = {
        makchang: { color: '#6B8E5A', label: '烤大肠', icon: 'fa-fire' },
        bulgogi:  { color: '#6B8E5A', label: '烤肉',   icon: 'fa-drumstick-bite' },
        mackerel: { color: '#6B8E5A', label: '炖鲭鱼', icon: 'fa-fish' },
        crab:     { color: '#6B8E5A', label: '酱蟹',   icon: 'fa-shrimp' }
    };

    const PLACES = [
        // 烤大肠 (막창)
        { name: '연막창',         lat: 33.4890, lng: 126.4890, type: 'makchang', addr: '济州市 新大路16街 49号',        addrKo: '제주시 신대로16길 49',             desc: '炭火烤大肠专门店，人气颇高。', features: ['炭火烧烤', '大肠', '人气店'] },
        { name: '고향숯불막창',    lat: 33.5152, lng: 126.5527, type: 'makchang', addr: '济州市 一周东路 281号',          addrKo: '제주시 일주동로 281',              desc: '炭火风味浓郁，当地居民常去的大肠烤肉店。', features: ['炭火', '当地特色', '大肠'] },
        { name: '용팔이막창',     lat: 33.4900, lng: 126.4870, type: 'makchang', addr: '济州市 月浪路4街 17号',          addrKo: '제주시 월랑로4길 17',             desc: '老字号大肠专门店，口感软糯。', features: ['老字号', '大肠', '软糯'] },
        { name: '골목빈통구이',   lat: 33.2500, lng: 126.4140, type: 'makchang', addr: '西归浦市 天帝渊路185街 6号',     addrKo: '서귀포시 천제연로185길 6',         desc: '中文区人气烤肉餐厅，大肠新鲜美味。', features: ['中文区', '大肠', '人气'] },
        // 烤肉 (불고기)
        { name: '왕일번지식당',   lat: 33.3231, lng: 126.8445, type: 'bulgogi',  addr: '西归浦市 表善面 城邑里 547-1',   addrKo: '서귀포시 표선면 성읍리 547-1',    desc: '济州黑猪肉烤肉名店，肉质鲜嫩。', features: ['黑猪肉', '烤肉', '名店'] },
        { name: '털보식당',       lat: 33.5411, lng: 126.6713, type: 'bulgogi',  addr: '济州市 朝天邑 咸德里 1002-84',  addrKo: '제주시 조천읍 함덕리 1002-84',    desc: '咸德海岸边的烤肉餐厅，景观绝佳。', features: ['海景', '黑猪肉', '烤肉'] },
        { name: '비자향',         lat: 33.5226, lng: 126.8528, type: 'bulgogi',  addr: '济州市 旧左邑 平岱里 3204-3',   addrKo: '제주시 구좌읍 평대리 3204-3',     desc: '旧左邑的本地人气烤肉店。', features: ['本地推荐', '黑猪肉', '烤肉'] },
        { name: '금능녹원',       lat: 33.3874, lng: 126.2324, type: 'bulgogi',  addr: '济州市 翰林邑 金陵里 1716',     addrKo: '제주시 한림읍 금능리 1716',       desc: '翰林地区的烤肉名店，食材新鲜。', features: ['翰林', '黑猪肉', '新鲜食材'] },
        // 炖鲭鱼 (고등어찜/조림)
        { name: '맛나식당',       lat: 33.4332, lng: 126.9275, type: 'mackerel', addr: '西归浦市 城山邑 古城里 316-9',   addrKo: '서귀포시 성산읍 고성리 316-9',    desc: '城山地区炖鲭鱼老店，味道醇厚。', features: ['炖鲭鱼', '老店', '城山'] },
        { name: '중문고등어조밥', lat: 33.2414, lng: 126.4244, type: 'mackerel', addr: '西归浦市 上礼洞 3706号 (中文)', addrKo: '서귀포시 상예동 3706',            desc: '中文观光区附近的鲭鱼饭名店。', features: ['炖鲭鱼', '鲭鱼饭', '中文区'] },
        { name: '이춘옥원조 고등어쌈밥', lat: 33.4738, lng: 126.4058, type: 'mackerel', addr: '济州市 涯月邑 一周西路 7213', addrKo: '제주시 애월읍 일주서로 7213', desc: '涯月传统鲭鱼饭，原味正宗。', features: ['原味', '鲭鱼饭', '传统'] },
        { name: '네거리식당',     lat: 33.2454, lng: 126.5664, type: 'mackerel', addr: '西归浦市 西归洞 320-9',         addrKo: '서귀포시 서귀동 320-9',           desc: '十字路口老食堂，炖鲭鱼深受好评。', features: ['老食堂', '炖鲭鱼', '好评'] },
        // 酱蟹 (간장게장)
        { name: '장모식당',       lat: 33.5030, lng: 126.5361, type: 'crab',     addr: '济州市 二都二洞 257-6',         addrKo: '제주시 이도이동 257-6',           desc: '酱蟹饭套餐丰盛，口碑极佳。', features: ['酱蟹', '套餐', '口碑好'] },
        { name: '제주로운청해원', lat: 33.4350, lng: 126.9270, type: 'crab',     addr: '西归浦市 城山邑 古城里 212-13', addrKo: '서귀포시 성산읍 고성리 212-13',  desc: '城山日出峰附近的酱蟹名店。', features: ['酱蟹', '城山日出峰', '名店'] },
        { name: '종달수다녀',     lat: 33.4644, lng: 126.8367, type: 'crab',     addr: '济州市 旧左邑 终达里 2566-1',  addrKo: '제주시 구좌읍 종달리 2566-1',    desc: '终达里海边酱蟹餐厅，新鲜实惠。', features: ['酱蟹', '海边', '新鲜'] }
    ];

    // ===== 마커 생성 함수 =====
    function createIcon(color, iconClass, name) {
        return L.divIcon({
            html: `<div class="circle-marker" style="background:${color};">
                       <i class="fas ${iconClass}"></i>
                   </div>
                   <div class="marker-label" style="color:${color};">${name}</div>`,
            className: 'custom-marker-icon',
            iconSize: [25, 25],
            iconAnchor: [12, 12],
            popupAnchor: [0, -12]
        });
    }

    function createPopup(place) {
        const cfg = TYPE_CONFIG[place.type];
        const googleUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}&query=${place.lat},${place.lng}`;
        const naverUrl  = `https://map.naver.com/v5/search/${encodeURIComponent(place.name)}`;
        const features  = place.features ? place.features.join('、') : '';

        return `<div class="custom-popup" style="border-color:${cfg.color};">
            <button class="popup-close-btn" style="color:${cfg.color};" onclick="this.closest('.leaflet-popup').querySelector('.leaflet-popup-close-button').click()"><i class="fas fa-times"></i></button>
            <div class="popup-header" style="border-bottom-color:${cfg.color};">
                <h3 class="popup-title" style="color:${cfg.color};">${place.name}</h3>
                <span class="type-badge" style="background:${cfg.color};">${cfg.label}</span>
            </div>
            <div class="popup-body">
                <div class="popup-row">
                    <i class="fas fa-map-marker-alt popup-icon" style="color:${cfg.color};"></i>
                    <span>${place.addrKo || ''}<br><small style="color:#888;">${place.addr}</small></span>
                </div>
                <div class="popup-row">
                    <i class="fas fa-info-circle popup-icon" style="color:${cfg.color};"></i>
                    <span>${place.desc}</span>
                </div>
                ${features ? `<div class="popup-row">
                    <i class="fas fa-star popup-icon" style="color:${cfg.color};"></i>
                    <span>${features}</span>
                </div>` : ''}
            </div>
            <div class="popup-footer">
                <a href="${googleUrl}" target="_blank" class="map-btn" style="border-color:${cfg.color};color:${cfg.color};">
                    <i class="fab fa-google" style="color:${cfg.color};"></i> 谷歌地图
                </a>
                <a href="${naverUrl}" target="_blank" class="map-btn" style="border-color:${cfg.color};color:${cfg.color};">
                    <i class="fas fa-map" style="color:${cfg.color};"></i> Naver地图
                </a>
            </div>
        </div>`;
    }

    // ===== 마커 추가 =====
    const allMarkers = [];
    const clusterGroup = L.markerClusterGroup();
    PLACES.forEach(p => {
        const cfg = TYPE_CONFIG[p.type];
        const marker = L.marker([p.lat, p.lng], { icon: createIcon(cfg.color, cfg.icon, p.name) });
        marker.bindPopup(createPopup(p), { maxWidth: 300, minWidth: 240 });
        clusterGroup.addLayer(marker);
        allMarkers.push({ marker, place: p });
    });
    map.addLayer(clusterGroup);

    // ===== 줌 레벨에 따라 마커 크기 조절 =====
    function updateMarkerSize() {
        const currentZoom = map.getZoom();
        if (currentZoom >= 16) {
            allMarkers.forEach(({ marker }) => {
                const el = marker.getElement();
                if (el) { const cm = el.querySelector('.circle-marker'); if (cm) cm.classList.remove('small-dot'); }
            });
            return;
        }
        allMarkers.forEach(({ marker }) => {
            const el = marker.getElement();
            if (el) { const cm = el.querySelector('.circle-marker'); if (cm) cm.classList.remove('small-dot'); }
        });
        const checkRadius = Math.max(15, 80 - (currentZoom * 4));
        allMarkers.forEach(({ marker, place }, index) => {
            const el = marker.getElement();
            if (!el) return;
            const cm = el.querySelector('.circle-marker');
            if (!cm) return;
            const pos = map.latLngToContainerPoint([place.lat, place.lng]);
            let hasNearby = false;
            for (let i = 0; i < allMarkers.length; i++) {
                if (i === index) continue;
                const other = allMarkers[i].place;
                const otherPos = map.latLngToContainerPoint([other.lat, other.lng]);
                const dist = Math.sqrt(Math.pow(pos.x - otherPos.x, 2) + Math.pow(pos.y - otherPos.y, 2));
                if (dist < checkRadius) { hasNearby = true; break; }
            }
            if (hasNearby) cm.classList.add('small-dot');
        });
    }
    map.on('zoomend', updateMarkerSize);
    clusterGroup.on('animationend', updateMarkerSize);
    </script>
</body>
</html>
